<!-- Generated by CrewCFO Agent - 2025-12-16T10:32:31.741645 -->

# CrewCFO Valuation Module - REST API Design

**Base URL:** `/api/valuation`

## Overview

The Valuation Module API provides endpoints for managing valuation snapshots, driver scores, scenario simulations, exit readiness assessments, and roadmap items. All endpoints require authentication and operate within tenant context.

## Authentication & Authorization

- **Authentication:** Bearer token required in `Authorization` header
- **Tenant Context:** All requests operate within authenticated user's tenant
- **Rate Limiting:** 1000 requests/hour per tenant
- **Permissions:** Role-based access (Owner, CFO, Bookkeeper)

---

## 1. Valuation Snapshots

### GET `/snapshots`
Get valuation snapshots with filtering and pagination.

**Query Parameters:**
- `page` (int): Page number (default: 1)
- `limit` (int): Items per page (default: 20, max: 100)
- `from_date` (string): ISO date filter
- `to_date` (string): ISO date filter
- `tier` (string): Filter by tier (below_avg, avg, above_avg)

**Response:**
```json
{
  "success": true,
  "data": {
    "snapshots": [
      {
        "id": "uuid",
        "tenant_id": "uuid",
        "as_of_date": "2024-01-15T00:00:00Z",
        "ttm_revenue": 2500000.00,
        "ttm_sde": 375000.00,
        "ttm_ebitda": 325000.00,
        "tier": "avg",
        "multiple_low": 4.5,
        "multiple_high": 5.0,
        "ev_low": 1462500.00,
        "ev_high": 1625000.00,
        "confidence_score": 0.87,
        "drivers_summary": {
          "management_independence": 3.2,
          "financial_records": 4.1,
          "recurring_revenue": 2.8,
          "operational_systems": 3.5,
          "customer_diversity": 3.9,
          "market_outlook": 4.2
        },
        "created_at": "2024-01-15T10:30:00Z",
        "updated_at": "2024-01-15T10:30:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 45,
      "pages": 3
    }
  }
}
```

### GET `/snapshots/latest`
Get the most recent valuation snapshot.

**Response:**
```json
{
  "success": true,
  "data": {
    "snapshot": {
      "id": "uuid",
      "tenant_id": "uuid",
      "as_of_date": "2024-01-15T00:00:00Z",
      "ttm_revenue": 2500000.00,
      "ttm_sde": 375000.00,
      "ttm_ebitda": 325000.00,
      "tier": "avg",
      "multiple_low": 4.5,
      "multiple_high": 5.0,
      "ev_low": 1462500.00,
      "ev_high": 1625000.00,
      "confidence_score": 0.87,
      "value_delta": {
        "from_previous": 125000.00,
        "percentage_change": 8.3
      },
      "automation_flags": {
        "requires_review": false,
        "high_confidence": true,
        "tier_change": false
      }
    }
  }
}
```

### POST `/snapshots`
Create a new valuation snapshot.

**Request:**
```json
{
  "as_of_date": "2024-01-15T00:00:00Z",
  "force_recalculation": false,
  "include_projections": true
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "snapshot": { /* snapshot object */ },
    "processing_time_ms": 1250,
    "data_sources_used": ["qbo", "books_os", "market_data"]
  }
}
```

### POST `/snapshots/{id}/recalculate`
Trigger recalculation of existing snapshot.

**Request:**
```json
{
  "recalculate_drivers": true,
  "update_multiples": true,
  "reason": "Updated financial data"
}
```

---

## 2. Driver Scores

### GET `/drivers`
Get all driver scores with filtering.

**Query Parameters:**
- `as_of_date` (string): Specific date (default: latest)
- `driver_key` (string): Filter by specific driver
- `include_evidence` (boolean): Include supporting evidence

**Response:**
```json
{
  "success": true,
  "data": {
    "scores": [
      {
        "id": "uuid",
        "tenant_id": "uuid",
        "as_of_date": "2024-01-15T00:00:00Z",
        "driver_key": "management_independence",
        "score": 3.2,
        "max_score": 5.0,
        "confidence": 0.82,
        "computed_by": "ml_model_v2.1",
        "evidence_summary": {
          "owner_hours_per_week": 55,
          "key_person_dependency": "high",
          "delegation_score": 2.1
        },
        "improvement_potential": 1.8,
        "created_at": "2024-01-15T10:30:00Z"
      }
    ],
    "overall_score": 3.45,
    "tier_impact": "avg"
  }
}
```

### POST `/drivers/{driver_key}/score`
Update score for specific driver.

**Request:**
```json
{
  "score": 3.5,
  "evidence_refs": ["doc_123", "metric_456"],
  "manual_override": true,
  "override_reason": "Recent operational improvements",
  "confidence_override": 0.95
}
```

### GET `/drivers/evidence/{score_id}`
Get evidence supporting a driver score.

**Response:**
```json
{
  "success": true,
  "data": {
    "evidence": {
      "score_id": "uuid",
      "driver_key": "financial_records",
      "supporting_data": [
        {
          "type": "qbo_metric",
          "description": "Monthly close completion time",
          "value": "8.5 days average",
          "impact": "negative",
          "weight": 0.3
        },
        {
          "type": "books_os_audit",
          "description": "Chart of accounts structure",
          "value": "well_organized",
          "impact": "positive",
          "weight": 0.4
        }
      ],
      "ai_reasoning": "Score reduced due to extended monthly close cycle...",
      "human_reviews": []
    }
  }
}
```

---

## 3. Scenario Simulation

### POST `/scenarios`
Create new scenario simulation.

**Request:**
```json
{
  "name": "Increased Recurring Revenue Scenario",
  "description": "What if we grow maintenance contracts by 40%",
  "baseline_snapshot_id": "uuid",
  "adjustments": {
    "recurring_revenue_pct": 0.40,
    "owner_hours_reduction": 10,
    "crew_productivity_increase": 0.15,
    "gross_margin_improvement": 0.02
  },
  "time_horizon_months": 12
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "scenario": {
      "id": "uuid",
      "name": "Increased Recurring Revenue Scenario",
      "status": "created",
      "baseline_ev": 1500000.00,
      "projected_ev": null,
      "created_at": "2024-01-15T10:30:00Z"
    }
  }
}
```

### POST `/scenarios/{id}/run`
Execute scenario simulation.

**Response:**
```json
{
  "success": true,
  "data": {
    "results": {
      "scenario_id": "uuid",
      "baseline_metrics": {
        "ttm_revenue": 2500000.00,
        "ttm_sde": 375000.00,
        "ev_range": [1462500.00, 1625000.00]
      },
      "projected_metrics": {
        "ttm_revenue": 2850000.00,
        "ttm_sde": 485000.00,
        "ev_range": [1940000.00, 2425000.00]
      },
      "improvements": {
        "revenue_uplift": 350000.00,
        "sde_uplift": 110000.00,
        "ev_uplift": 477500.00,
        "multiple_improvement": 0.3,
        "driver_score_changes": {
          "management_independence": 0.8,
          "recurring_revenue": 1.2
        }
      },
      "confidence": 0.78,
      "assumptions": [
        "Market conditions remain stable",
        "Customer retention rate maintains at 85%"
      ]
    }
  }
}
```

---

## 4. Exit Readiness & Deal Room

### GET `/exit-readiness`
Get current exit readiness assessment.

**Response:**
```json
{
  "success": true,
  "data": {
    "assessment": {
      "overall_score": 72,
      "readiness_level": "moderate",
      "estimated_timeline": "12-18 months",
      "categories": {
        "financial_readiness": {
          "score": 85,
          "items_complete": 12,
          "items_total": 15
        },
        "operational_readiness": {
          "score": 68,
          "items_complete": 8,
          "items_total": 12
        },
        "legal_readiness": {
          "score": 45,
          "items_complete": 5,
          "items_total": 10
        }
      },
      "critical_gaps": [
        "Management employment agreements missing",
        "Customer contracts need standardization",
        "Insurance policies require review"
      ],
      "last_assessed": "2024-01-15T10:30:00Z"
    }
  }
}
```

### GET `/exit-readiness/checklist`
Get due diligence checklist.

**Response:**
```json
{
  "success": true,
  "data": {
    "checklist": {
      "categories": [
        {
          "name": "Financial Documents",
          "items": [
            {
              "id": "uuid",
              "description": "3 years audited financial statements",
              "status": "complete",
              "priority": "critical",
              "artifact_refs": ["doc_123"],
              "due_date": null
            },
            {
              "id": "uuid",
              "description": "Monthly financials for TTM",
              "status": "in_progress",
              "priority": "high",
              "completion_pct": 75,
              "due_date": "2024-02-01T00:00:00Z"
            }
          ]
        }
      ],
      "completion_summary": {
        "total_items": 45,
        "completed": 32,
        "in_progress": 8,
        "not_started": 5,
        "completion_pct": 71
      }
    }
  }
}
```

### POST `/exit-readiness/artifacts/generate`
Generate specific artifact.

**Request:**
```json
{
  "artifact_type": "financial_summary",
  "parameters": {
    "periods": 36,
    "include_projections": true,
    "format": "pdf"
  }
}
```

---

## 5. Valuation Roadmap

### GET `/roadmap`
Get roadmap items with filtering.

**Query Parameters:**
- `status` (string): Filter by status (pending, in_progress, complete)
- `priority` (string): Filter by priority (low, medium, high, critical)
- `driver_key` (string): Filter by associated driver
- `timeframe` (string): weekly, monthly, quarterly

**Response:**
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": "uuid",
        "title": "Implement weekly financial reporting",
        "description": "Establish consistent weekly P&L and cash flow reporting",
        "driver_key": "financial_records",
        "expected_impact_ev": 125000.00,
        "effort_level": "medium",
        "priority": "high",
        "status": "pending",
        "automation_tier": "rules",
        "estimated_hours": 16,
        "due_date": "2024-02-15T00:00:00Z",
        "assigned_to": null,
        "created_at": "2024-01-15T10:30:00Z"
      }
    ],
    "summary": {
      "total_potential_ev": 850000.00,
      "items_by_status": {
        "pending": 12,
        "in_progress": 5,
        "complete": 8
      }
    }
  }
}
```

### POST `/roadmap/generate`
Generate AI-recommended roadmap items.

**Request:**
```json
{
  "focus_drivers": ["management_independence", "operational_systems"],
  "time_horizon": "quarterly",
  "effort_preference": "medium",
  "include_automation": true
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "generated_items": [
      {
        "title": "Automate crew scheduling system",
        "description": "Implement digital scheduling to reduce owner involvement",
        "driver_key": "management_independence",
        "expected_impact_ev": 200000.00,
        "effort_level": "high",
        "confidence": 0.82,
        "reasoning": "Based on similar implementations, this typically reduces owner hours by 8-12 per week..."
      }
    ],
    "generation_metadata": {
      "model_version": "roadmap_agent_v1.2",
      "data_sources": ["industry_benchmarks", "tenant_history"],
      "confidence": 0.79
    }
  }
}
```

---

## 6. Market Data & Benchmarks

### GET `/multiples`
Get current market multiples by tier.

**Response:**
```json
{
  "success": true,
  "data": {
    "multiples": {
      "below_avg": {
        "sde_multiple": 3.0,
        "ebitda_multiple": 3.2,
        "revenue_multiple": 0.8
      },
      "avg": {
        "sde_multiple": 4.75,
        "ebitda_multiple": 5.0,
        "revenue_multiple": 1.2
      },
      "above_avg": {
        "sde_multiple": 7.0,
        "ebitda_multiple": 7.5,
        "revenue_multiple": 1.8
      }
    },
    "market_conditions": {
      "trend": "stable",
      "last_updated": "2024-01-10T00:00:00Z",
      "data_sources": ["axial", "bizbuysell", "industry_reports"]
    }
  }
}
```

### GET `/benchmarks`
Get industry benchmarks and comparisons.

**Response:**
```json
{
  "success": true,
  "data": {
    "benchmarks": {
      "revenue_ranges": {
        "small": [500000, 2000000],
        "medium": [2000000, 10000000],
        "large": [10000000, 50000000]
      },
      "profitability": {
        "gross_margin": {
          "p25": 0.35,
          "median": 0.42,
          "p75": 0.48
        },
        "sde_margin": {
          "p25": 0.12,
          "median": 0.18,
          "p75": 0.25
        }
      },
      "operational": {
        "owner_hours_per_week": {
          "p25": 35,
          "median": 50,
          "p75": 65
        },
        "recurring_revenue_pct": {
          "p25": 0.15,
          "median": 0.28,
          "p75": 0.45
        }
      }
    }
  }
}
```

---

## 7. System Endpoints

### POST `/webhooks/qbo-sync`
Webhook for QBO data synchronization.

**Request:**
```json
{
  "event_type": "data_updated",
  "tenant_id": "uuid",
  "entities_changed": ["customers", "items", "transactions"],
  "timestamp": "2024-01-15T10:30:00Z"
}
```

### GET `/health`
Health check endpoint.

**Response:**
```json
{
  "success": true,
  "data": {
    "status": "healthy",
    "version": "1.0.0",
    "dependencies": {
      "database": "healthy",
      "qbo_api": "healthy",
      "ml_service": "healthy"
    },
    "timestamp": "2024-01-15T10:30:00Z"
  }
}
```

### GET `/metrics`
Get module performance metrics.

**Response:**
```json
{
  "success": true,
  "data": {
    "performance": {
      "avg_snapshot_generation_time": 1.2,
      "driver_scoring_accuracy": 0.87,
      "automation_rate": 0.82,
      "human_review_rate": 0.18
    },
    "usage": {
      "snapshots_generated_today": 45,
      "scenarios_run_today": 12,
      "roadmap_items_created": 8
    }
  }
}
```

---

## Error Handling

All endpoints return errors in this format:

```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Invalid date format provided",
    "details": {
      "field": "as_of_date",
      "expected": "ISO 8601 format"
    }
  }
}
```

### Common Error Codes:
- `VALIDATION_ERROR` - Invalid request parameters
- `INSUFFICIENT_DATA` - Not enough data to perform calculation
- `CONFIDENCE_TOO_LOW` - AI confidence below threshold
- `RATE_LIMIT_EXCEEDED` - Too many requests
- `TENANT_NOT_FOUND` - Invalid tenant context
- `UNAUTHORIZED` - Authentication required
- `FORBIDDEN` - Insufficient permissions

---

## Automation & Human-in-Loop Rules

### Confidence Thresholds:
- **≥95%**: Auto-commit results
- **80-94%**: Commit with flagged review
- **60-79%**: Draft mode, requires human confirmation
- **<60%**: Exception queue, manual review required

### Human Approval Required:
- Valuation changes > $50,000
- Tier changes (below_avg ↔ avg ↔ above_avg)
- Driver score changes > 1.0 points
- Scenario projections with confidence < 70%

### Rate Limits:
- Standard: 1000 requests/hour per tenant
- Snapshot generation: 10/hour per tenant
- Scenario simulation: 20/hour per tenant
- Webhook endpoints: 100/minute per tenant