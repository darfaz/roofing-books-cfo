# Automation Flow: Books Month-End Close

> **Module**: Books OS  
> **Version**: 1.0.0  
> **Platform**: n8n  
> **Trigger**: Scheduled (1st business day) + Manual  

---

## Overview

This workflow orchestrates the monthly close process, coordinating automated tasks with human checkpoints to ensure books are closed within 5 business days.

---

## Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BOOKS MONTH-END CLOSE                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                 â”‚
â”‚  â”‚  TRIGGER    â”‚  Cron: 0 8 1-7 * * (8am, days 1-7, monthly)    â”‚
â”‚  â”‚  (Schedule) â”‚  OR Manual webhook                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                 â”‚
â”‚         â”‚                                                        â”‚
â”‚         â–¼                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ FOR EACH tenant WHERE close_not_started(period)             â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚â”‚
â”‚  â”‚  â”‚ Initialize  â”‚ â†’ Create close_run                         â”‚â”‚
â”‚  â”‚  â”‚ Close Run   â”‚ â†’ Generate checklist                       â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â†’ Send initiation notification             â”‚â”‚
â”‚  â”‚         â”‚                                                   â”‚â”‚
â”‚  â”‚         â–¼                                                   â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚â”‚
â”‚  â”‚  â”‚ Sync All    â”‚ â†’ Trigger QBO sync                         â”‚â”‚
â”‚  â”‚  â”‚ Systems     â”‚ â†’ Trigger Jobber/ST sync                   â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â†’ Wait for completion                      â”‚â”‚
â”‚  â”‚         â”‚                                                   â”‚â”‚
â”‚  â”‚         â–¼                                                   â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚â”‚
â”‚  â”‚  â”‚ Process     â”‚ â†’ Run classification_agent                 â”‚â”‚
â”‚  â”‚  â”‚ Transactionsâ”‚ â†’ Log results                              â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                            â”‚â”‚
â”‚  â”‚         â”‚                                                   â”‚â”‚
â”‚  â”‚         â–¼                                                   â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚â”‚
â”‚  â”‚  â”‚ Check       â”‚ â†’ Count unclassified                       â”‚â”‚
â”‚  â”‚  â”‚ Exceptions  â”‚ â†’ Count untagged COGS                      â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â†’ Generate exception report                â”‚â”‚
â”‚  â”‚         â”‚                                                   â”‚â”‚
â”‚  â”‚    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                                              â”‚â”‚
â”‚  â”‚    â”‚         â”‚                                              â”‚â”‚
â”‚  â”‚    â–¼         â–¼                                              â”‚â”‚
â”‚  â”‚ [>0 exc] [0 exc]                                            â”‚â”‚
â”‚  â”‚    â”‚         â”‚                                              â”‚â”‚
â”‚  â”‚    â–¼         â”‚                                              â”‚â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                                              â”‚â”‚
â”‚  â”‚ â”‚ Notify   â”‚ â”‚                                              â”‚â”‚
â”‚  â”‚ â”‚ Human    â”‚ â”‚                                              â”‚â”‚
â”‚  â”‚ â”‚ Review   â”‚ â”‚                                              â”‚â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚                                              â”‚â”‚
â”‚  â”‚      â”‚       â”‚                                              â”‚â”‚
â”‚  â”‚      â–¼       â”‚                                              â”‚â”‚
â”‚  â”‚ [WAIT for human completion]                                 â”‚â”‚
â”‚  â”‚      â”‚       â”‚                                              â”‚â”‚
â”‚  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”˜                                              â”‚â”‚
â”‚  â”‚         â”‚                                                   â”‚â”‚
â”‚  â”‚         â–¼                                                   â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚â”‚
â”‚  â”‚  â”‚ Run Auto    â”‚ â†’ Prepaid amortization                     â”‚â”‚
â”‚  â”‚  â”‚ Adjustments â”‚ â†’ Depreciation                             â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â†’ Standard accruals                        â”‚â”‚
â”‚  â”‚         â”‚                                                   â”‚â”‚
â”‚  â”‚         â–¼                                                   â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚â”‚
â”‚  â”‚  â”‚ Bank Recon  â”‚ â†’ Calculate reconciliation                 â”‚â”‚
â”‚  â”‚  â”‚ (Agent)     â”‚ â†’ Flag exceptions                          â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                            â”‚â”‚
â”‚  â”‚         â”‚                                                   â”‚â”‚
â”‚  â”‚    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                                              â”‚â”‚
â”‚  â”‚    â”‚         â”‚                                              â”‚â”‚
â”‚  â”‚    â–¼         â–¼                                              â”‚â”‚
â”‚  â”‚ [diff>0] [diff=0]                                           â”‚â”‚
â”‚  â”‚    â”‚         â”‚                                              â”‚â”‚
â”‚  â”‚    â–¼         â”‚                                              â”‚â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                                              â”‚â”‚
â”‚  â”‚ â”‚ Human    â”‚ â”‚                                              â”‚â”‚
â”‚  â”‚ â”‚ Bank     â”‚ â”‚                                              â”‚â”‚
â”‚  â”‚ â”‚ Review   â”‚ â”‚                                              â”‚â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚                                              â”‚â”‚
â”‚  â”‚      â”‚       â”‚                                              â”‚â”‚
â”‚  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”˜                                              â”‚â”‚
â”‚  â”‚         â”‚                                                   â”‚â”‚
â”‚  â”‚         â–¼                                                   â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚â”‚
â”‚  â”‚  â”‚ Generate    â”‚ â†’ Draft P&L                                â”‚â”‚
â”‚  â”‚  â”‚ Reports     â”‚ â†’ Draft Balance Sheet                      â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â†’ Job Profitability                        â”‚â”‚
â”‚  â”‚         â”‚                                                   â”‚â”‚
â”‚  â”‚         â–¼                                                   â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚â”‚
â”‚  â”‚  â”‚ Request     â”‚ â†’ Send reports to owner                    â”‚â”‚
â”‚  â”‚  â”‚ Review      â”‚ â†’ Schedule review call (optional)          â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                            â”‚â”‚
â”‚  â”‚         â”‚                                                   â”‚â”‚
â”‚  â”‚         â–¼                                                   â”‚â”‚
â”‚  â”‚ [WAIT for review completion]                                â”‚â”‚
â”‚  â”‚         â”‚                                                   â”‚â”‚
â”‚  â”‚         â–¼                                                   â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚â”‚
â”‚  â”‚  â”‚ Apply Final â”‚ â†’ Post any adjustments                     â”‚â”‚
â”‚  â”‚  â”‚ Adjustments â”‚ â†’ from review                              â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                            â”‚â”‚
â”‚  â”‚         â”‚                                                   â”‚â”‚
â”‚  â”‚         â–¼                                                   â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚â”‚
â”‚  â”‚  â”‚ Generate    â”‚ â†’ Final P&L                                â”‚â”‚
â”‚  â”‚  â”‚ Final       â”‚ â†’ Final Balance Sheet                      â”‚â”‚
â”‚  â”‚  â”‚ Reports     â”‚ â†’ Archive period                           â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                            â”‚â”‚
â”‚  â”‚         â”‚                                                   â”‚â”‚
â”‚  â”‚         â–¼                                                   â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚â”‚
â”‚  â”‚  â”‚ Request     â”‚ â†’ Send certification request               â”‚â”‚
â”‚  â”‚  â”‚ Certificationâ”‚ â†’ Wait for signature                      â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                            â”‚â”‚
â”‚  â”‚         â”‚                                                   â”‚â”‚
â”‚  â”‚         â–¼                                                   â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚â”‚
â”‚  â”‚  â”‚ CLOSE       â”‚ â†’ Lock period                              â”‚â”‚
â”‚  â”‚  â”‚ COMPLETE    â”‚ â†’ Update status                            â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â†’ Send completion notification             â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## n8n Workflow JSON

```json
{
  "name": "Books Month-End Close",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "triggerAtHour": 8,
              "triggerAtMinute": 0
            }
          ]
        }
      },
      "name": "Schedule Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "position": [250, 300],
      "typeVersion": 1
    },
    {
      "parameters": {
        "path": "close-trigger",
        "httpMethod": "POST",
        "responseMode": "responseNode"
      },
      "name": "Manual Trigger Webhook",
      "type": "n8n-nodes-base.webhook",
      "position": [250, 450],
      "typeVersion": 1
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT t.id as tenant_id, t.name as tenant_name \nFROM tenants t \nWHERE t.is_active = true \n  AND NOT EXISTS (\n    SELECT 1 FROM close_runs cr \n    WHERE cr.tenant_id = t.id \n      AND cr.period_year = EXTRACT(YEAR FROM CURRENT_DATE - INTERVAL '1 month') \n      AND cr.period_month = EXTRACT(MONTH FROM CURRENT_DATE - INTERVAL '1 month')\n  )"
      },
      "name": "Get Tenants Needing Close",
      "type": "n8n-nodes-base.postgres",
      "position": [500, 375],
      "typeVersion": 1,
      "credentials": {
        "postgres": "Supabase Connection"
      }
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "name": "Loop Tenants",
      "type": "n8n-nodes-base.splitInBatches",
      "position": [700, 375],
      "typeVersion": 1
    },
    {
      "parameters": {
        "functionCode": "const tenantId = items[0].json.tenant_id;\nconst now = new Date();\nconst lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);\nconst periodYear = lastMonth.getFullYear();\nconst periodMonth = lastMonth.getMonth() + 1;\nconst periodLabel = `${periodYear}-${String(periodMonth).padStart(2, '0')}`;\n\n// Calculate target completion (7th business day)\nlet targetDate = new Date(now);\nlet businessDays = 0;\nwhile (businessDays < 7) {\n  targetDate.setDate(targetDate.getDate() + 1);\n  const day = targetDate.getDay();\n  if (day !== 0 && day !== 6) businessDays++;\n}\n\nreturn [{\n  json: {\n    tenant_id: tenantId,\n    period_year: periodYear,\n    period_month: periodMonth,\n    period_label: periodLabel,\n    target_completion: targetDate.toISOString(),\n    initiated_by: 'auto'\n  }\n}];"
      },
      "name": "Prepare Close Run Data",
      "type": "n8n-nodes-base.function",
      "position": [900, 375],
      "typeVersion": 1
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "close_runs",
        "columns": "tenant_id, period_year, period_month, period_label, target_completion, initiated_by",
        "returnFields": "id"
      },
      "name": "Create Close Run",
      "type": "n8n-nodes-base.postgres",
      "position": [1100, 375],
      "typeVersion": 1
    },
    {
      "parameters": {
        "url": "={{$env.SPECOS_API_URL}}/sync/trigger",
        "method": "POST",
        "body": {
          "tenant_id": "={{$node[\"Prepare Close Run Data\"].json.tenant_id}}",
          "full_sync": true,
          "sources": ["qbo", "jobber"]
        },
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpHeaderAuth"
      },
      "name": "Trigger System Sync",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1300, 375],
      "typeVersion": 3
    },
    {
      "parameters": {
        "time": 5,
        "unit": "minutes"
      },
      "name": "Wait for Sync",
      "type": "n8n-nodes-base.wait",
      "position": [1500, 375],
      "typeVersion": 1
    },
    {
      "parameters": {
        "url": "={{$env.SPECOS_API_URL}}/classification/process-pending",
        "method": "POST",
        "body": {
          "tenant_id": "={{$node[\"Prepare Close Run Data\"].json.tenant_id}}",
          "period": "={{$node[\"Prepare Close Run Data\"].json.period_label}}"
        }
      },
      "name": "Process Pending Transactions",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1700, 375],
      "typeVersion": 3
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  COUNT(*) FILTER (WHERE approval_status = 'needs_review') as unclassified_count,\n  COUNT(*) FILTER (WHERE job_id IS NULL AND a.requires_job_tag = true) as untagged_cogs\nFROM transactions_categorized tc\nJOIN accounts a ON tc.account_id = a.id\nWHERE tc.tenant_id = '{{$node[\"Prepare Close Run Data\"].json.tenant_id}}'\n  AND tc.transaction_date >= '{{$node[\"Prepare Close Run Data\"].json.period_label}}-01'\n  AND tc.transaction_date < '{{$node[\"Prepare Close Run Data\"].json.period_label}}-01'::date + INTERVAL '1 month'"
      },
      "name": "Check Exceptions",
      "type": "n8n-nodes-base.postgres",
      "position": [1900, 375],
      "typeVersion": 1
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{$json.unclassified_count + $json.untagged_cogs}}",
              "operation": "larger",
              "value2": 0
            }
          ]
        }
      },
      "name": "Has Exceptions?",
      "type": "n8n-nodes-base.if",
      "position": [2100, 375],
      "typeVersion": 1
    },
    {
      "parameters": {
        "resource": "message",
        "operation": "post",
        "channel": "={{$env.SLACK_BOOKKEEPING_CHANNEL}}",
        "text": "ğŸ“‹ *{{$node[\"Prepare Close Run Data\"].json.period_label}} Close - Action Required*\n\nTenant: {{$node[\"Get Tenants Needing Close\"].json.tenant_name}}\n\nExceptions to review:\nâ€¢ Unclassified transactions: {{$json.unclassified_count}}\nâ€¢ COGS missing job tags: {{$json.untagged_cogs}}\n\n<{{$env.DASHBOARD_URL}}/close/{{$node[\"Create Close Run\"].json.id}}/exceptions|Review Exceptions>"
      },
      "name": "Notify Exception Review",
      "type": "n8n-nodes-base.slack",
      "position": [2300, 275],
      "typeVersion": 1
    },
    {
      "parameters": {
        "url": "={{$env.SPECOS_API_URL}}/adjustments/auto",
        "method": "POST",
        "body": {
          "tenant_id": "={{$node[\"Prepare Close Run Data\"].json.tenant_id}}",
          "period": "={{$node[\"Prepare Close Run Data\"].json.period_label}}",
          "types": ["prepaid_amortization", "depreciation", "standard_accruals"]
        }
      },
      "name": "Run Auto Adjustments",
      "type": "n8n-nodes-base.httpRequest",
      "position": [2500, 375],
      "typeVersion": 3
    },
    {
      "parameters": {
        "url": "={{$env.SPECOS_API_URL}}/reconciliation/bank",
        "method": "POST",
        "body": {
          "tenant_id": "={{$node[\"Prepare Close Run Data\"].json.tenant_id}}",
          "period": "={{$node[\"Prepare Close Run Data\"].json.period_label}}"
        }
      },
      "name": "Run Bank Reconciliation",
      "type": "n8n-nodes-base.httpRequest",
      "position": [2700, 375],
      "typeVersion": 3
    },
    {
      "parameters": {
        "url": "={{$env.SPECOS_API_URL}}/reports/generate",
        "method": "POST",
        "body": {
          "tenant_id": "={{$node[\"Prepare Close Run Data\"].json.tenant_id}}",
          "period": "={{$node[\"Prepare Close Run Data\"].json.period_label}}",
          "reports": ["pnl", "balance_sheet", "job_profitability", "ar_aging", "ap_aging"],
          "draft": true
        }
      },
      "name": "Generate Draft Reports",
      "type": "n8n-nodes-base.httpRequest",
      "position": [2900, 375],
      "typeVersion": 3
    },
    {
      "parameters": {
        "resource": "message",
        "operation": "send",
        "toEmail": "={{$node[\"Get Tenants Needing Close\"].json.owner_email}}",
        "subject": "{{$node[\"Prepare Close Run Data\"].json.period_label}} Draft Financial Reports Ready for Review",
        "html": true,
        "message": "<h2>Your {{$node[\"Prepare Close Run Data\"].json.period_label}} draft financials are ready</h2>\n\n<p>Hi {{$node[\"Get Tenants Needing Close\"].json.owner_name}},</p>\n\n<p>The draft financial reports for {{$node[\"Prepare Close Run Data\"].json.period_label}} have been generated and are ready for your review.</p>\n\n<h3>Quick Summary</h3>\n<ul>\n<li><strong>Revenue:</strong> ${{$json.reports.pnl.revenue}}</li>\n<li><strong>Gross Profit:</strong> ${{$json.reports.pnl.gross_profit}} ({{$json.reports.pnl.gp_margin}}%)</li>\n<li><strong>Net Income:</strong> ${{$json.reports.pnl.net_income}}</li>\n</ul>\n\n<p><a href=\"{{$env.DASHBOARD_URL}}/close/{{$node[\"Create Close Run\"].json.id}}/review\">Review & Approve Reports</a></p>\n\n<p>Please review by {{$node[\"Prepare Close Run Data\"].json.target_completion}} to stay on track for timely close.</p>"
      },
      "name": "Send Review Request",
      "type": "n8n-nodes-base.emailSend",
      "position": [3100, 375],
      "typeVersion": 1
    },
    {
      "parameters": {
        "operation": "update",
        "table": "close_runs",
        "updateKey": "id",
        "columns": "status",
        "values": {
          "id": "={{$node[\"Create Close Run\"].json.id}}",
          "status": "awaiting_review"
        }
      },
      "name": "Update Status Awaiting Review",
      "type": "n8n-nodes-base.postgres",
      "position": [3300, 375],
      "typeVersion": 1
    }
  ],
  "connections": {
    "Schedule Trigger": {
      "main": [[{"node": "Get Tenants Needing Close", "type": "main", "index": 0}]]
    },
    "Manual Trigger Webhook": {
      "main": [[{"node": "Get Tenants Needing Close", "type": "main", "index": 0}]]
    },
    "Get Tenants Needing Close": {
      "main": [[{"node": "Loop Tenants", "type": "main", "index": 0}]]
    },
    "Loop Tenants": {
      "main": [[{"node": "Prepare Close Run Data", "type": "main", "index": 0}]]
    },
    "Prepare Close Run Data": {
      "main": [[{"node": "Create Close Run", "type": "main", "index": 0}]]
    },
    "Create Close Run": {
      "main": [[{"node": "Trigger System Sync", "type": "main", "index": 0}]]
    },
    "Trigger System Sync": {
      "main": [[{"node": "Wait for Sync", "type": "main", "index": 0}]]
    },
    "Wait for Sync": {
      "main": [[{"node": "Process Pending Transactions", "type": "main", "index": 0}]]
    },
    "Process Pending Transactions": {
      "main": [[{"node": "Check Exceptions", "type": "main", "index": 0}]]
    },
    "Check Exceptions": {
      "main": [[{"node": "Has Exceptions?", "type": "main", "index": 0}]]
    },
    "Has Exceptions?": {
      "main": [
        [{"node": "Notify Exception Review", "type": "main", "index": 0}],
        [{"node": "Run Auto Adjustments", "type": "main", "index": 0}]
      ]
    },
    "Notify Exception Review": {
      "main": [[{"node": "Run Auto Adjustments", "type": "main", "index": 0}]]
    },
    "Run Auto Adjustments": {
      "main": [[{"node": "Run Bank Reconciliation", "type": "main", "index": 0}]]
    },
    "Run Bank Reconciliation": {
      "main": [[{"node": "Generate Draft Reports", "type": "main", "index": 0}]]
    },
    "Generate Draft Reports": {
      "main": [[{"node": "Send Review Request", "type": "main", "index": 0}]]
    },
    "Send Review Request": {
      "main": [[{"node": "Update Status Awaiting Review", "type": "main", "index": 0}]]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}
```

---

## Environment Variables Required

| Variable | Description | Example |
|----------|-------------|---------|
| `SPECOS_API_URL` | Internal API endpoint | `https://api.specos.io` |
| `DASHBOARD_URL` | Dashboard base URL | `https://app.specos.io` |
| `SLACK_BOOKKEEPING_CHANNEL` | Slack channel for alerts | `#bookkeeping-alerts` |
| `POSTGRES_CONNECTION` | Supabase connection string | `postgresql://...` |

---

## Error Handling

| Error | Recovery |
|-------|----------|
| Sync timeout | Retry once, then alert and continue |
| Classification failure | Log, flag tenant for manual processing |
| Report generation failure | Retry, then alert finance team |
| Email delivery failure | Retry 3x, then log for manual followup |

---

## Monitoring

| Metric | Alert Condition |
|--------|-----------------|
| Workflow execution time | > 30 minutes |
| Failed nodes | Any failure |
| Tenants without close | > 10 business days into month |
| Exception rate | > 25% of transactions |
